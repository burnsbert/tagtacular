/* Tagtacular 1.0.1 -- Copyright 2015 Eric Burns, MIT License: https://github.com/burnsbert/tagtacular/blob/master/license.txt */
!function(a){"use strict";a.fn.tagtacular=function(b){var c=this,d=[],e=[],f="edit",g="",h=0,i="",j="",k=function(b){b=M.formatTagName(a.trim(b));var c=M.validate(b,M);c===!0?s(b)?M.messageAddTagAlreadyExists&&M.flashFailure(M.messageAddTagAlreadyExists):(d.push(b),C(b,e)||(e.push(b),e=M.sort(e)),M.configSortTags&&(d=M.sort(d)),M.commitAddTag(b,M.entityId,M),p(),l(!0),M.messageAddTagSuccess&&M.flashSuccess(M.messageAddTagSuccess)):c&&M.flashFailure(c),t()},l=function(a,b){"edit"==f?m(a,b):"view"==f&&n(),j.length>0&&M.flashSuccess(j),i.length>0&&M.flashFailure(i),M.postDrawEditTray(f)},m=function(b,e){if(e=e||g||"",M.configSelectBox){var i='<select class="tagtacular_add_input">',j=u();i+='<option value=""></option>',a.each(j,function(a,b){i+='<option value="'+b+'">'+b+"</option>"}),i+="</select>"}else var h=M.configPlaceholderText?' placeholder="'+M.configPlaceholderText+'"':"",i='<input type="text" class="tagtacular_add_input"'+h+' value="'+e+'" />';M.configShowAddButton&&(i+=M.getAddButtonHtml(M)),M.configShowSwitchButton&&(i+=M.getSwitchButtonHtml(f,M)),M.configRenderFlashMessageSpan&&(i+='<span style="display: none;" class="tagtacular_flash"></span>'),c.find(".tagtacular_edit_tray").html(i),M.configShowAddButton&&c.find(".tagtacular_edit_tray .tagtacular_add_button").bind("click",function(a){a.preventDefault();var b=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();M.configSelectBox&&b.length<1?M.messageEmptySelectBoxFailure&&M.flashFailure(M.messageEmptySelectBoxFailure):k(b)}),M.configShowSwitchButton&&c.find(".tagtacular_edit_tray .tagtacular_switch_button").bind("click",function(a){a.preventDefault();var b=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();M.configAddOnSwitch&&b.length>=1&&k(b),g=c.find(".tagtacular_edit_tray .tagtacular_add_input").val(),f="view",p(),l(!0),M.postSwitchLayout(f)}),c.find(".tagtacular_edit_tray .tagtacular_add_input").bind("keydown",function(b){var e=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();-1!=a.inArray(b.which,M.configDeleteLastOnEmptyKeys)&&e.length<1&&(b.preventDefault(),b.stopPropagation(),z(d[d.length-1]))}),c.find(".tagtacular_edit_tray .tagtacular_add_input").bind("keypress",function(b){if(-1!=a.inArray(b.which,M.configDelimiters)){b.preventDefault(),b.stopPropagation();var d=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();d.length>0&&!x()&&k(d)}}),c.find(".tagtacular_edit_tray .tagtacular_add_input").bind("keyup",function(){x()?(c.find(".tagtacular_add_button").attr("disabled","disabled"),M.configAddOnSwitch&&c.find(".tagtacular_switch_button").attr("disabled","disabled")):(c.find(".tagtacular_add_button").removeAttr("disabled"),M.configAddOnSwitch&&c.find(".tagtacular_switch_button").removeAttr("disabled"))}),!M.configSelectBox&&M.configAutocomplete&&c.find(".tagtacular_edit_tray .tagtacular_add_input").autocomplete({source:u(),select:function(a,b){c.find(".tagtacular_edit_tray .tagtacular_add_input").val(""),k(b.item.value)}}),b&&t()},n=function(){var a="";M.configShowSwitchButton&&M.configAllowedToEdit&&(a+=M.getSwitchButtonHtml(f,M)),M.configRenderFlashMessageSpan&&(a+='<span style="display: none;" class="tagtacular_flash"></span>'),c.find(".tagtacular_edit_tray").html(a),M.configShowSwitchButton&&M.configAllowedToEdit&&c.find(".tagtacular_edit_tray .tagtacular_switch_button").bind("click",function(a){a.preventDefault(),f="edit",p(),l(!0),g="",M.postSwitchLayout(f)})},o=function(){M.configAllowedToEdit||(f="view"),c.html(M.getLayoutHtml(M)),p(),l(!1)},p=function(){d=A(d),"edit"==f?q():"view"==f&&r(),M.postDrawTagList(f)},q=function(){var b=[];a.each(d,function(a,c){b.push(M.getTagHtml(c,f,M))});var e=b.join("");c.find(".tagtacular_tag_tray").html(e),c.find(".tagtacular_tag_tray .tagtacular_tag").last().find(".tagtacular_delim").remove(),c.find(".tagtacular_tag_tray .tagtacular_delete").bind("click",function(b){b.preventDefault();var c=a(this).closest(".tagtacular_tag"),d=c.find(".tagtacular_value").text();c.remove(),z(d)})},r=function(){var b=[];a.each(d,function(a,c){b.push(M.getTagHtml(c,f,M))});var e=b.join("");c.find(".tagtacular_tag_tray").html(e),c.find(".tagtacular_tag_tray .tagtacular_tag").last().find(".tagtacular_delim").remove()},s=function(a){return C(a,d)},t=function(){var a=c.find(".tagtacular_edit_tray .tagtacular_add_input"),b=a.val();a.focus().val("").val(b)},u=function(){return M.configAutocompletePrune?v():e},v=function(){var b=a.grep(e,function(b){return a.inArray(b,d)<0});return b},w=function(){var b=a.extend({},M);return b.entityTags=d,b.systemTags=e,b.mode=f,b.toplevel=c,b},x=function(){if(!M.configLimitToExisting)return!1;var a=c.find(".tagtacular_add_input");if(a.length<1)return!1;var b=a.val();return 0==b.length?!1:!B(b)},y=function(b){var c=[];return a.each(b,function(b,d){-1==a.inArray(d,c)&&c.push(d)}),c},z=function(b){d=a.grep(d,function(a){return M.configCaseInsensitive?a.toUpperCase()!=b.toUpperCase():a!=b}),M.entityTags=d,M.commitRemoveTag(b,M.entityId,M),p(),l(!0,c.find(".tagtacular_add_input").val()),M.messageRemoveTagSuccess&&M.flashSuccess(M.messageRemoveTagSuccess,"removeTag",b),t()},A=function(a){return M.configSortTags&&(a=M.sort(a)),a},B=function(a){return C(a,e)},C=function(b,c){var d=a.grep(c,function(a){return M.configCaseInsensitive?a.toUpperCase()==b.toUpperCase():a==b});return d.length>0},D=function(a){return a.sort(function(a,b){var a=a.toLowerCase(),b=b.toLowerCase();return a==b?0:a>b?1:-1}),a},E=function(a){i=a,j="";var b=c.find(".tagtacular_flash");b.html(a),b.addClass("tagtacular_failure"),b.removeClass("tagtacular_success"),b.show();var d=++h;M.configFlashFailureHideAfter&&setTimeout(function(){if(h==d){var a=c.find(".tagtacular_flash");i="",a.fadeOut()}},1e3*M.configFlashFailureHideAfter)},F=function(a){j=a,i="";var b=c.find(".tagtacular_flash");b.html(a),b.addClass("tagtacular_success"),b.removeClass("tagtacular_failure"),b.show();var d=++h;M.configFlashSuccessHideAfter&&setTimeout(function(){if(h==d){var a=c.find(".tagtacular_flash");j="",a.fadeOut()}},1e3*M.configFlashSuccessHideAfter)},G=function(a){return'<button class="tagtacular_add_button">'+a.configAddButtonText+"</button>"},H=function(a){return a.configEditTrayFirst?'<div class="tagtacular_edit_tray"></div><div class="tagtacular_tag_tray"></div>':'<div class="tagtacular_tag_tray"></div><div class="tagtacular_edit_tray"></div>'},I=function(a,b){var c="view"==a?b.configSwitchButtonTextInView:b.configSwitchButtonTextInEdit;return'<button class="tagtacular_switch_button">'+c+"</button>"},J=function(a,b,c){return"edit"==b?'<span class="tagtacular_tag tagtacular_tag_edit"><span class="tagtacular_value">'+a+'</span>&nbsp;<a class="tagtacular_delete" href="#">'+c.configDeleteSymbol+'</a><span class="tagtacular_delim">'+c.configTagSeparator+"</span></span>":"view"==b?'<span class="tagtacular_tag tagtacular_tag_view"><span class="tagtacular_value">'+a+'</span><span class="tagtacular_delim">'+c.configTagSeparator+"</span></span>":void 0},K=function(a,b){if(a.length<b.configMinimumTagLength)return b.messageTagTooShort;if(a.length>b.configMaximumTagLength)return b.messageTagTooLong;var c=b.validationPattern;return c.test(a)?!0:b.messageTagNameInvalid},L=function(a){return a},M={commitAddTag:L,commitRemoveTag:L,configAddOnSwitch:!0,configAddButtonText:"Add",configAllowedToEdit:!0,configAutocomplete:!0,configAutocompletePrune:!0,configCaseInsensitive:!0,configDeleteSymbol:"X",configDeleteLastOnEmptyKeys:[],configDelimiters:[13,44],configEditTrayFirst:!1,configFlashFailureHideAfter:5,configFlashSuccessHideAfter:5,configFormatTagNamesOnInit:!1,configLimitToExisting:!1,configMinimumTagLength:1,configMaximumTagLength:32,configPlaceholderText:!1,configRenderFlashMessageSpan:!0,configSelectBox:!1,configShowAddButton:!0,configShowSwitchButton:!0,configSortTags:!0,configSwitchButtonTextInEdit:"Done",configSwitchButtonTextInView:"Edit",configTagSeparator:"",entityId:null,entityType:null,entityTags:[],getAddButtonHtml:G,getLayoutHtml:H,getSwitchButtonHtml:I,getTagHtml:J,flashFailure:E,flashSuccess:F,formatTagName:L,messageAddTagSuccess:"tag added",messageAddTagAlreadyExists:"tag is already assigned",messageEmptySelectBoxFailure:"you must select a tag before adding it",messageRemoveTagSuccess:"tag removed",messageTagNameInvalid:"invalid tag name: tag names can only include letters, numbers, underscores, hyphens, and spaces",messageTagTooLong:"tag name too long, maximum length of [configMaximumTagLength]",messageTagTooShort:"tag name too short, minimum length of [configMinimumTagLength]",mode:"edit",postDrawEditTray:L,postDrawTagList:L,postSwitchLayout:L,sort:D,systemTags:[],validate:K,validationPattern:/^[0-9A-Za-z_\- ]+$/},N=function(b){return b=b||{},a.each(b,function(a,b){M[a]=b}),M.messageTagTooLong=M.messageTagTooLong.replace("[configMaximumTagLength]",M.configMaximumTagLength),M.messageTagTooShort=M.messageTagTooShort.replace("[configMinimumTagLength]",M.configMinimumTagLength),d=A(M.entityTags),e=M.systemTags.concat(d),e=M.sort(y(e)),M.configFormatTagNamesOnInit&&(d=a.map(d,function(a){return M.formatTagName(a)}),e=a.map(e,function(a){return M.formatTagName(a)})),f=M.mode,M.toplevel=c,o(),c};return a.extend(c,{addTag:k}),a.extend(c,{flashFailure:M.flashFailure}),a.extend(c,{flashSuccess:M.flashSuccess}),a.extend(c,{getEntityId:function(){return M.entityId}}),a.extend(c,{getEntityType:function(){return M.entityType}}),a.extend(c,{getEntityTags:function(){return d}}),a.extend(c,{getRemainingTags:v}),a.extend(c,{getState:w}),a.extend(c,{getSystemTags:function(){return e}}),a.extend(c,{removeTag:z}),a.extend(c,{tagtacular:N}),N(b)}}(jQuery);