/* Tagtacular 1.1.1 -- Copyright 2016 Eric Burns, MIT License: https://github.com/burnsbert/tagtacular/blob/master/license.txt */
!function(a){"use strict";a.fn.tagtacular=function(b){var c=this,d=[],e=[],f="edit",g="",h=0,i="",j="",k=null,l=!1,m=function(b){b=O.formatTagName(a.trim(b));var c=O.validate(b,O);c===!0?u(b)?O.messageAddTagAlreadyExists&&O.flashFailure(O.messageAddTagAlreadyExists):(d.push(b),E(b,e)||k||(e.push(b),e=O.sort(e)),O.configSortTags&&(d=O.sort(d)),O.commitAddTag(b,O.entityId,O),r(),n(!0),O.messageAddTagSuccess&&O.flashSuccess(O.messageAddTagSuccess)):c&&O.flashFailure(c),v()},n=function(a,b){"edit"==f?o(a,b):"view"==f&&p(),j.length>0&&O.flashSuccess(j),i.length>0&&O.flashFailure(i),O.postDrawEditTray(f)},o=function(b,e){if(e=e||g||"",O.configSelectBox){var i='<select class="tagtacular_add_input">',j=w();i+='<option value=""></option>',a.each(j,function(a,b){i+='<option value="'+b+'">'+b+"</option>"}),i+="</select>"}else var h=O.configPlaceholderText?' placeholder="'+O.configPlaceholderText+'"':"",i='<input type="text" class="tagtacular_add_input"'+h+' value="'+e+'" />';O.configShowAddButton&&(i+=O.getAddButtonHtml(O)),O.configShowSwitchButton&&(i+=O.getSwitchButtonHtml(f,O)),O.configRenderFlashMessageSpan&&(i+='<span style="display: none;" class="tagtacular_flash"></span>'),c.find(".tagtacular_edit_tray").html(i),O.configShowAddButton&&c.find(".tagtacular_edit_tray .tagtacular_add_button").bind("click",function(a){a.preventDefault();var b=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();O.configSelectBox&&b.length<1?O.messageEmptySelectBoxFailure&&O.flashFailure(O.messageEmptySelectBoxFailure):m(b)}),O.configShowSwitchButton&&c.find(".tagtacular_edit_tray .tagtacular_switch_button").bind("click",function(a){a.preventDefault();var b=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();O.configAddOnSwitch&&b.length>=1&&m(b),g=c.find(".tagtacular_edit_tray .tagtacular_add_input").val(),f="view",r(),n(!0),O.postSwitchLayout(f)}),c.find(".tagtacular_edit_tray .tagtacular_add_input").bind("keydown",function(b){var e=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();-1!=a.inArray(b.which,O.configDeleteLastOnEmptyKeys)&&e.length<1&&(b.preventDefault(),b.stopPropagation(),B(d[d.length-1]))}),c.find(".tagtacular_edit_tray .tagtacular_add_input").bind("keypress",function(b){if(-1!=a.inArray(b.which,O.configDelimiters)){b.preventDefault(),b.stopPropagation();var d=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();d.length>0&&!z()&&m(d)}}),c.find(".tagtacular_edit_tray .tagtacular_add_input").bind("keyup",function(a){z()?(c.find(".tagtacular_add_button").attr("disabled","disabled"),O.configAddOnSwitch&&c.find(".tagtacular_switch_button").attr("disabled","disabled")):(c.find(".tagtacular_add_button").removeAttr("disabled"),O.configAddOnSwitch&&c.find(".tagtacular_switch_button").removeAttr("disabled"))}),!O.configSelectBox&&O.configAutocomplete&&(k?c.find(".tagtacular_edit_tray .tagtacular_add_input").autocomplete({source:O.remoteDataSource,select:function(a,b){c.find(".tagtacular_edit_tray .tagtacular_add_input").val(""),m(b.item.value),l=!1},response:function(a,b){l=!1;for(var e=b.content.length-1;e>=0;e--)E(b.content[e].value,d)?b.content.splice(e,1):b.content[e].value.toLowerCase()==c.find(".tagtacular_edit_tray .tagtacular_add_input").val().toLowerCase()&&(l=!0)}}):c.find(".tagtacular_edit_tray .tagtacular_add_input").autocomplete({source:w(),select:function(a,b){c.find(".tagtacular_edit_tray .tagtacular_add_input").val(""),m(b.item.value)}})),b&&v()},p=function(){var a="";O.configShowSwitchButton&&O.configAllowedToEdit&&(a+=O.getSwitchButtonHtml(f,O)),O.configRenderFlashMessageSpan&&(a+='<span style="display: none;" class="tagtacular_flash"></span>'),c.find(".tagtacular_edit_tray").html(a),O.configShowSwitchButton&&O.configAllowedToEdit&&c.find(".tagtacular_edit_tray .tagtacular_switch_button").bind("click",function(a){a.preventDefault(),f="edit",r(),n(!0),g="",O.postSwitchLayout(f)})},q=function(){O.configAllowedToEdit||(f="view"),c.html(O.getLayoutHtml(O)),r(),n(!1)},r=function(){d=C(d),"edit"==f?s():"view"==f&&t(),O.postDrawTagList(f)},s=function(){var b=[];a.each(d,function(a,c){b.push(O.getTagHtml(c,f,O))});var e=b.join("");c.find(".tagtacular_tag_tray").html(e),c.find(".tagtacular_tag_tray .tagtacular_tag").last().find(".tagtacular_delim").remove(),c.find(".tagtacular_tag_tray .tagtacular_delete").bind("click",function(b){b.preventDefault();var c=a(this).closest(".tagtacular_tag"),d=c.find(".tagtacular_value").text();c.remove(),B(d)})},t=function(){var b=[];a.each(d,function(a,c){b.push(O.getTagHtml(c,f,O))});var e=b.join("");c.find(".tagtacular_tag_tray").html(e),c.find(".tagtacular_tag_tray .tagtacular_tag").last().find(".tagtacular_delim").remove()},u=function(a){return E(a,d)},v=function(){var a=c.find(".tagtacular_edit_tray .tagtacular_add_input"),b=a.val();a.focus().val("").val(b)},w=function(){return O.configAutocompletePrune?x():e},x=function(){var b=a.grep(e,function(b){return a.inArray(b,d)<0});return b},y=function(){var b=a.extend({},O);return b.entityTags=d,b.systemTags=k?e:null,b.mode=f,b.toplevel=c,b},z=function(){if(!O.configLimitToExisting)return!1;var a=c.find(".tagtacular_add_input");if(a.length<1)return!1;var b=a.val();return 0==b.length?!1:k?!0:!D(b)},A=function(b){var c=[],d=!1;return a.each(b,function(a,b){d!=b&&(c.push(b),d=b)}),c},B=function(b){d=a.grep(d,function(a){return O.configCaseInsensitive?a.toUpperCase()!=b.toUpperCase():a!=b}),O.entityTags=d,O.commitRemoveTag(b,O.entityId,O),r(),n(!0,c.find(".tagtacular_add_input").val()),O.messageRemoveTagSuccess&&O.flashSuccess(O.messageRemoveTagSuccess,"removeTag",b),v()},C=function(a){return O.configSortTags&&(a=O.sort(a)),a},D=function(a){return k?!0:void E(a,e)},E=function(b,c){var d=a.grep(c,function(a){return O.configCaseInsensitive?a.toUpperCase()==b.toUpperCase():a==b});return d.length>0},F=function(a){return a.sort(function(a,b){var a=a.toLowerCase(),b=b.toLowerCase();return a==b?0:a>b?1:-1}),a},G=function(a){i=a,j="";var b=c.find(".tagtacular_flash");b.html(a),b.addClass("tagtacular_failure"),b.removeClass("tagtacular_success"),b.show();var d=++h;O.configFlashFailureHideAfter&&setTimeout(function(){if(h==d){var a=c.find(".tagtacular_flash");i="",a.fadeOut()}},1e3*O.configFlashFailureHideAfter)},H=function(a){j=a,i="";var b=c.find(".tagtacular_flash");b.html(a),b.addClass("tagtacular_success"),b.removeClass("tagtacular_failure"),b.show();var d=++h;O.configFlashSuccessHideAfter&&setTimeout(function(){if(h==d){var a=c.find(".tagtacular_flash");j="",a.fadeOut()}},1e3*O.configFlashSuccessHideAfter)},I=function(a){return'<button class="tagtacular_add_button">'+a.configAddButtonText+"</button>"},J=function(a){return a.configEditTrayFirst?'<div class="tagtacular_edit_tray"></div><div class="tagtacular_tag_tray"></div>':'<div class="tagtacular_tag_tray"></div><div class="tagtacular_edit_tray"></div>'},K=function(a,b){var c="view"==a?b.configSwitchButtonTextInView:b.configSwitchButtonTextInEdit;return'<button class="tagtacular_switch_button">'+c+"</button>"},L=function(a,b,c){return"edit"==b?'<span class="tagtacular_tag tagtacular_tag_edit"><span class="tagtacular_value">'+a+'</span>&nbsp;<a class="tagtacular_delete" href="#">'+c.configDeleteSymbol+'</a><span class="tagtacular_delim">'+c.configTagSeparator+"</span></span>":"view"==b?'<span class="tagtacular_tag tagtacular_tag_view"><span class="tagtacular_value">'+a+'</span><span class="tagtacular_delim">'+c.configTagSeparator+"</span></span>":void 0},M=function(a,b){if(a.length<b.configMinimumTagLength)return b.messageTagTooShort;if(a.length>b.configMaximumTagLength)return b.messageTagTooLong;var c=b.validationPattern;return c.test(a)?!0:b.messageTagNameInvalid},N=function(a){return a},O={commitAddTag:N,commitRemoveTag:N,configAddOnSwitch:!0,configAddButtonText:"Add",configAllowedToEdit:!0,configAutocomplete:!0,configAutocompletePrune:!0,configCaseInsensitive:!0,configDeleteSymbol:"X",configDeleteLastOnEmptyKeys:[],configDelimiters:[13,44],configEditTrayFirst:!1,configFlashFailureHideAfter:5,configFlashSuccessHideAfter:5,configFormatTagNamesOnInit:!1,configLimitToExisting:!1,configMinimumTagLength:1,configMaximumTagLength:32,configPlaceholderText:!1,configRenderFlashMessageSpan:!0,configSelectBox:!1,configShowAddButton:!0,configShowSwitchButton:!0,configSortTags:!0,configSwitchButtonTextInEdit:"Done",configSwitchButtonTextInView:"Edit",configTagSeparator:"",entityId:null,entityType:null,entityTags:[],getAddButtonHtml:I,getLayoutHtml:J,getSwitchButtonHtml:K,getTagHtml:L,flashFailure:G,flashSuccess:H,formatTagName:N,messageAddTagSuccess:"tag added",messageAddTagAlreadyExists:"tag is already assigned",messageEmptySelectBoxFailure:"you must select a tag before adding it",messageRemoveTagSuccess:"tag removed",messageTagNameInvalid:"invalid tag name: tag names can only include letters, numbers, underscores, hyphens, and spaces",messageTagTooLong:"tag name too long, maximum length of [configMaximumTagLength]",messageTagTooShort:"tag name too short, minimum length of [configMinimumTagLength]",mode:"edit",postDrawEditTray:N,postDrawTagList:N,postSwitchLayout:N,remoteDataSource:null,sort:F,systemTags:[],validate:M,validationPattern:/^[0-9A-Za-z_\- ]+$/},P=function(b){return b=b||{},a.each(b,function(a,b){O[a]=b}),O.messageTagTooLong=O.messageTagTooLong.replace("[configMaximumTagLength]",O.configMaximumTagLength),O.messageTagTooShort=O.messageTagTooShort.replace("[configMinimumTagLength]",O.configMinimumTagLength),d=C(O.entityTags),k=O.remoteDataSource,k||(e=O.systemTags.concat(d),e=A(O.sort(e))),O.configFormatTagNamesOnInit&&(d=a.map(d,function(a,b){return O.formatTagName(a)}),k||(e=a.map(e,function(a,b){return O.formatTagName(a)}))),f=O.mode,O.toplevel=c,q(),c};return a.extend(c,{addTag:m}),a.extend(c,{flashFailure:O.flashFailure}),a.extend(c,{flashSuccess:O.flashSuccess}),a.extend(c,{getEntityId:function(){return O.entityId}}),a.extend(c,{getEntityType:function(){return O.entityType}}),a.extend(c,{getEntityTags:function(){return d}}),a.extend(c,{getRemainingTags:x}),a.extend(c,{getState:y}),a.extend(c,{getSystemTags:function(){return k?[]:e}}),a.extend(c,{removeTag:B}),a.extend(c,{tagtacular:P}),P(b)}}(jQuery);