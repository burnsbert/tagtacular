!function(a){"use strict";a.fn.tagtacular=function(b){var c=this,d=[],e=[],f="edit",g="",h=0,i="",j="",k=function(b){b=K.formatTagName(a.trim(b));var c=K.validate(b,K);c===!0?s(b)?K.messageAddTagAlreadyExists&&K.flashFailure(K.messageAddTagAlreadyExists):(d.push(b),A(b,e)||(e.push(b),e=K.sort(e)),K.configSortTags&&(d=K.sort(d)),K.commitAddTag(b,K.entityId,K),p(),l(!0),K.messageAddTagSuccess&&K.flashSuccess(K.messageAddTagSuccess)):c&&K.flashFailure(c),t()},l=function(a,b){"edit"==f?m(a,b):"view"==f&&n(),j.length>0&&K.flashSuccess(j),i.length>0&&K.flashFailure(i),K.postDrawEditTray(f)},m=function(b,e){if(e=e||g||"",K.configSelectBox){var i='<select class="tagtacular_add_input">',j=u();i+='<option value=""></option>',a.each(j,function(a,b){i+='<option value="'+b+'">'+b+"</option>"}),i+="</select>"}else var h=K.configPlaceholderText?' placeholder="'+K.configPlaceholderText+'"':"",i='<input type="text" class="tagtacular_add_input"'+h+' value="'+e+'" />';K.configShowAddButton&&(i+=K.getAddButtonHtml(K)),K.configShowSwitchButton&&(i+=K.getSwitchButtonHtml(f,K)),K.configRenderFlashMessageSpan&&(i+='<span style="display: none;" class="tagtacular_flash"></span>'),c.find(".tagtacular_edit_tray").html(i),K.configShowAddButton&&c.find(".tagtacular_edit_tray .tagtacular_add_button").bind("click",function(a){a.preventDefault();var b=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();K.configSelectBox&&b.length<1?K.messageEmptySelectBoxFailure&&K.flashFailure(K.messageEmptySelectBoxFailure):k(b)}),K.configShowSwitchButton&&c.find(".tagtacular_edit_tray .tagtacular_switch_button").bind("click",function(a){a.preventDefault();var b=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();K.configAddOnSwitch&&b.length>=1&&k(b),g=c.find(".tagtacular_edit_tray .tagtacular_add_input").val(),f="view",p(),l(!0),K.postSwitchLayout(f)}),c.find(".tagtacular_edit_tray .tagtacular_add_input").bind("keydown",function(b){var e=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();-1!=a.inArray(b.which,K.configDeleteLastOnEmptyKeys)&&e.length<1&&(b.preventDefault(),b.stopPropagation(),x(d[d.length-1]))}),c.find(".tagtacular_edit_tray .tagtacular_add_input").bind("keypress",function(b){if(-1!=a.inArray(b.which,K.configDelimiters)){b.preventDefault(),b.stopPropagation();var d=c.find(".tagtacular_edit_tray .tagtacular_add_input").val();d.length>0&&k(d)}}),!K.configSelectBox&&K.configAutocomplete&&c.find(".tagtacular_edit_tray .tagtacular_add_input").autocomplete({source:u(),select:function(a,b){c.find(".tagtacular_edit_tray .tagtacular_add_input").val(""),k(b.item.value)}}),b&&t()},n=function(){var a="";K.configShowSwitchButton&&K.configAllowedToEdit&&(a+=K.getSwitchButtonHtml(f,K)),K.configRenderFlashMessageSpan&&(a+='<span style="display: none;" class="tagtacular_flash"></span>'),c.find(".tagtacular_edit_tray").html(a),K.configShowSwitchButton&&K.configAllowedToEdit&&c.find(".tagtacular_edit_tray .tagtacular_switch_button").bind("click",function(a){a.preventDefault(),f="edit",p(),l(!0),g="",K.postSwitchLayout(f)})},o=function(){K.configAllowedToEdit||(f="view"),c.html(K.getLayoutHtml(K)),p(),l(!1)},p=function(){d=y(d),"edit"==f?q():"view"==f&&r(),K.postDrawTagList(f)},q=function(){var b=[];a.each(d,function(a,c){b.push(K.getTagHtml(c,f,K))});var e=b.join("");c.find(".tagtacular_tag_tray").html(e),c.find(".tagtacular_tag_tray .tagtacular_tag").last().find(".tagtacular_delim").remove(),c.find(".tagtacular_tag_tray .tagtacular_delete").bind("click",function(b){b.preventDefault();var c=a(this).closest(".tagtacular_tag"),d=c.find(".tagtacular_value").text();c.remove(),x(d)})},r=function(){var b=[];a.each(d,function(a,c){b.push(K.getTagHtml(c,f,K))});var e=b.join("");c.find(".tagtacular_tag_tray").html(e),c.find(".tagtacular_tag_tray .tagtacular_tag").last().find(".tagtacular_delim").remove()},s=function(a){return A(a,d)},t=function(){var a=c.find(".tagtacular_edit_tray .tagtacular_add_input"),b=a.val();a.focus().val("").val(b)},u=function(){return K.configAutocompletePrune?v():e},v=function(){var b=a.grep(e,function(b){return a.inArray(b,d)<0});return b},w=function(){var b=a.extend({},K);return b.entityTags=d,b.systemTags=e,b.mode=f,b.toplevel=c,b},x=function(b){d=a.grep(d,function(a){return K.configCaseInsensitive?a.toUpperCase()!=b.toUpperCase():a!=b}),K.commitRemoveTag(b,K.entityId,K),p(),l(!0,c.find(".tagtacular_add_input").val()),K.messageRemoveTagSuccess&&K.flashSuccess(K.messageRemoveTagSuccess,"removeTag",b),t()},y=function(a){return K.configSortTags&&(a=K.sort(a)),a},A=function(b,c){var d=a.grep(c,function(a){return K.configCaseInsensitive?a.toUpperCase()==b.toUpperCase():a==b});return d.length>0},B=function(a){return a.sort(function(a,b){var a=a.toLowerCase(),b=b.toLowerCase();return a==b?0:a>b?1:-1}),a},C=function(a){i=a,j="";var b=c.find(".tagtacular_flash");b.html(a),b.addClass("tagtacular_failure"),b.removeClass("tagtacular_success"),b.show();var d=++h;K.configFlashFailureHideAfter&&setTimeout(function(){if(h==d){var a=c.find(".tagtacular_flash");i="",a.fadeOut()}},1e3*K.configFlashFailureHideAfter)},D=function(a){j=a,i="";var b=c.find(".tagtacular_flash");b.html(a),b.addClass("tagtacular_success"),b.removeClass("tagtacular_failure"),b.show();var d=++h;K.configFlashSuccessHideAfter&&setTimeout(function(){if(h==d){var a=c.find(".tagtacular_flash");j="",a.fadeOut()}},1e3*K.configFlashSuccessHideAfter)},E=function(a){return'<button class="tagtacular_add_button">'+a.configAddButtonText+"</button>"},F=function(a){return a.configEditTrayFirst?'<div class="tagtacular_edit_tray"></div><div class="tagtacular_tag_tray"></div>':'<div class="tagtacular_tag_tray"></div><div class="tagtacular_edit_tray"></div>'},G=function(a,b){var c="view"==a?b.configSwitchButtonTextInView:b.configSwitchButtonTextInEdit;return'<button class="tagtacular_switch_button">'+c+"</button>"},H=function(a,b,c){return"edit"==b?'<span class="tagtacular_tag tagtacular_tag_edit"><span class="tagtacular_value">'+a+'</span>&nbsp;<a class="tagtacular_delete" href="#">'+c.configDeleteSymbol+'</a><span class="tagtacular_delim">'+c.configTagSeparator+"</span></span>":"view"==b?'<span class="tagtacular_tag tagtacular_tag_view"><span class="tagtacular_value">'+a+'</span><span class="tagtacular_delim">'+c.configTagSeparator+"</span></span>":void 0},I=function(a,b){if(a.length<b.configMinimumTagLength)return b.messageTagTooShort;if(a.length>b.configMaximumTagLength)return b.messageTagTooLong;var c=b.validationPattern;return c.test(a)?!0:b.messageTagNameInvalid},J=function(a){return a},K={commitAddTag:J,commitRemoveTag:J,configAddOnSwitch:!0,configAddButtonText:"Add",configAllowedToEdit:!0,configAutocomplete:!0,configAutocompletePrune:!0,configCaseInsensitive:!0,configDeleteSymbol:"X",configDeleteLastOnEmptyKeys:[],configDelimiters:[13,44],configEditTrayFirst:!1,configFlashFailureHideAfter:5,configFlashSuccessHideAfter:5,configFormatTagNamesOnInit:!1,configMinimumTagLength:1,configMaximumTagLength:32,configPlaceholderText:!1,configRenderFlashMessageSpan:!0,configSelectBox:!1,configShowAddButton:!0,configShowSwitchButton:!0,configSortTags:!0,configSwitchButtonTextInEdit:"Done",configSwitchButtonTextInView:"Edit",configTagSeparator:"",entityId:null,entityType:null,entityTags:[],getAddButtonHtml:E,getLayoutHtml:F,getSwitchButtonHtml:G,getTagHtml:H,flashFailure:C,flashSuccess:D,formatTagName:J,messageAddTagSuccess:"tag added",messageAddTagAlreadyExists:"tag is already assigned",messageEmptySelectBoxFailure:"you must select a tag before adding it",messageRemoveTagSuccess:"tag removed",messageTagNameInvalid:"invalid tag name: tag names can only include letters, numbers, underscores, hyphens, and spaces",messageTagTooLong:"tag name too long, maximum length of [configMaximumTagLength]",messageTagTooShort:"tag name too short, minimum length of [configMinimumTagLength]",mode:"edit",postDrawEditTray:J,postDrawTagList:J,postSwitchLayout:J,sort:B,systemTags:[],validate:I,validationPattern:/^[0-9A-Za-z_\- ]+$/},L=function(b){return b=b||{},a.each(b,function(a,b){K[a]=b}),K.messageTagTooLong=K.messageTagTooLong.replace("[configMaximumTagLength]",K.configMaximumTagLength),K.messageTagTooShort=K.messageTagTooShort.replace("[configMinimumTagLength]",K.configMinimumTagLength),d=y(K.entityTags),e=K.sort(a.unique(K.systemTags.concat(d))),K.configFormatTagNamesOnInit&&(d=a.map(d,function(a){return K.formatTagName(a)}),e=a.map(e,function(a){return K.formatTagName(a)})),f=K.mode,K.toplevel=c,o(),c};return a.extend(c,{addTag:k}),a.extend(c,{flashFailure:K.flashFailure}),a.extend(c,{flashSuccess:K.flashSuccess}),a.extend(c,{getEntityId:function(){return K.entityId}}),a.extend(c,{getEntityType:function(){return K.entityType}}),a.extend(c,{getEntityTags:function(){return d}}),a.extend(c,{getRemainingTags:v}),a.extend(c,{getState:w}),a.extend(c,{getSystemTags:function(){return e}}),a.extend(c,{removeTag:x}),a.extend(c,{tagtacular:L}),L(b)}}(jQuery);